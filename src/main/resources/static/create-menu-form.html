<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ایجاد منوی جدید</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h2 { color: #0056b3; }
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { background-color: #218838; }
        .message-container { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        a { display: inline-block; margin-top: 20px; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; }
        a:hover { background-color: #0056b3; }
    </style>
</head>
<body>
<h2>ایجاد منوی جدید</h2>

<!-- نمایش پیام‌ها -->
<div id="messageDisplay" class="message-container">
    <p></p>
</div>

<!-- فرم ایجاد منو -->
<form id="createMenuForm">
    <div>
        <label for="title">عنوان منو:</label>
        <input type="text" id="title" name="title" required>
    </div>
    <div>
        <label for="url">URL منو:</label>
        <input type="text" id="url" name="url" required>
    </div>
    <div>
        <label for="orderIndex">ترتیب نمایش (عدد):</label>
        <input type="number" id="orderIndex" name="orderIndex">
    </div>
    <div>
        <label for="requiredPermissionName">مجوز مورد نیاز:</label>
        <select id="requiredPermissionName" name="requiredPermissionName">
            <option value="">-- بدون مجوز (عمومی) --</option>
            <!-- گزینه‌های مجوز با جاوا اسکریپت پر می‌شود -->
        </select>
    </div>
    <button type="submit">ایجاد منو</button>
</form>

<br>
<a href="/user-list.html">⬅️ بازگشت به لیست کاربران</a>

<script>
    // تابع کمکی برای نمایش پیام‌ها
    function showMessage(msg, type) {
        const messageDisplay = document.getElementById('messageDisplay');
        const messageParagraph = messageDisplay.querySelector('p');
        messageParagraph.innerText = msg;
        messageDisplay.className = 'message-container'; // ریست کردن کلاس‌ها
        if (type) {
            messageDisplay.classList.add(type); // افزودن کلاس success یا error
        }
    }

    // تابع برای بارگذاری مجوزها در Dropdown
    function loadPermissionsIntoDropdown() {
        // از API عمومی permissions استفاده می‌کنیم
        fetch('/api/permissions')
            .then(response => {
                if (!response.ok) {
                    throw new Error('خطا در دریافت مجوزها: ' + response.statusText);
                }
                return response.json();
            })
            .then(permissions => {
                const selectElement = document.getElementById('requiredPermissionName');
                // پاک کردن گزینه‌های قبلی به جز گزینه پیش‌فرض
                selectElement.innerHTML = '<option value="">-- بدون مجوز (عمومی) --</option>';

                permissions.forEach(permission => {
                    const option = document.createElement('option');
                    option.value = permission.name;
                    option.innerText = permission.name;
                    selectElement.appendChild(option);
                });
            })
            .catch(error => {
                showMessage('❌ خطا در بارگذاری مجوزها: ' + error.message, 'error');
                console.error('Error loading permissions:', error);
            });
    }

    // Event Listener برای ارسال فرم
    document.getElementById('createMenuForm').addEventListener('submit', function(event) {
        event.preventDefault(); // جلوگیری از ارسال پیش‌فرض فرم

        const title = document.getElementById('title').value;
        const url = document.getElementById('url').value;
        const orderIndex = document.getElementById('orderIndex').value;
        const requiredPermissionName = document.getElementById('requiredPermissionName').value;

        // ساخت شیء درخواست JSON
        const menuData = {
            title: title,
            url: url,
            orderIndex: orderIndex ? parseInt(orderIndex) : null, // تبدیل به عدد یا null
            requiredPermissionName: requiredPermissionName || null // اگر خالی بود null بفرست
        };

        // ارسال درخواست POST به API
        fetch('/api/admin/menus/create', { // مسیر API که در AdminMenuWebController تعریف کردیم
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(menuData)
        })
            .then(response => {
                if (response.ok) {
                    return response.text(); // اگر بک‌اند پیام متنی برمی‌گرداند
                } else {
                    return response.text().then(errorMessage => {
                        throw new Error(errorMessage || 'خطا در ایجاد منو'); // پیام خطا از بک‌اند
                    });
                }
            })
            .then(message => {
                showMessage(message, 'success');
                document.getElementById('createMenuForm').reset(); // ریست کردن فرم بعد از موفقیت
                loadPermissionsIntoDropdown(); // بارگذاری مجدد Dropdown اگر نیاز باشد
            })
            .catch(error => {
                showMessage('❌ ' + error.message, 'error');
                console.error('Error creating menu:', error);
            });
    });

    // بارگذاری مجوزها هنگام لود شدن صفحه
    window.onload = loadPermissionsIntoDropdown;
</script>
</body>
</html>