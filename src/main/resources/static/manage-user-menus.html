<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مدیریت نقش‌های کاربران و دسترسی منوها</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h2, h3 { color: #0056b3; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, button { padding: 10px 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ddd; font-size: 1rem; cursor: pointer; }
        button { background-color: #007bff; color: white; border: none; }
        button.remove-role-btn { background-color: #dc3545; margin-right: 5px; }
        button:hover { background-color: #0056b3; }
        button.remove-role-btn:hover { background-color: #c82333; }
        ul { list-style-type: none; padding: 0; }
        li { background-color: #e9e9e9; margin-bottom: 8px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        #userRoles, #userAccessibleMenus { border: 1px solid #ccc; padding: 10px; min-height: 50px; background-color: white; border-radius: 5px; }
        #message-manage { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .menu-item-status { font-weight: bold; margin-right: 10px; }
        .has-access { color: green; }
        .no-access { color: red; }
    </style>
</head>
<body>

<h2>مدیریت نقش‌های کاربران و دسترسی منوها</h2>

<label for="userSelect">انتخاب کاربر:</label>
<select id="userSelect" onchange="loadUserRolesAndMenus()">
</select>

<h3>نقش‌های این کاربر</h3>
<ul id="userRoles"></ul>

<hr> <h3>لیست تمام منوها و وضعیت دسترسی این کاربر</h3>
<ul id="allMenusWithAccessStatus"></ul>

<hr> <h3>اختصاص نقش جدید به کاربر</h3>
<label for="roleSelect">انتخاب نقش برای افزودن:</label>
<select id="roleSelect">
</select><br><br>

<button onclick="assignRoleToUser()">اختصاص نقش</button>

<p id="message-manage"></p>

<br>
<a href="user-list.html">⬅️ بازگشت به لیست کاربران</a>

<script>
    let allRoles = [];
    let allMenus = []; // برای ذخیره تمام منوها

    function showMessageManage(msg, type) {
        const messageElement = document.getElementById('message-manage');
        messageElement.innerText = msg;
        messageElement.className = '';
        if (type) {
            messageElement.classList.add(type);
        }
    }

    function loadUsers() {
        fetch('/api/users')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">-- یک کاربر انتخاب کنید --</option>';
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.innerText = user.username;
                    select.appendChild(option);
                });
                if (data.length > 0) {
                    loadRoles();
                    loadAllMenus(); // بارگذاری تمام منوها
                }
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری کاربران: ' + error.message, 'error');
                console.error('Error loading users:', error);
            });
    }

    function loadRoles() {
        fetch('/api/roles')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status} - ${res.status === 404 ? 'اندپوینت یافت نشد یا دسترسی رد شد.' : 'خطای سرور.'}`);
                }
                return res.json();
            })
            .then(data => {
                allRoles = data;
                const select = document.getElementById('roleSelect');
                select.innerHTML = '';
                data.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.innerText = role.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری نقش‌ها: ' + error.message, 'error');
                console.error('Error loading roles:', error);
            });
    }

    // تابع جدید: بارگذاری تمام منوها (برای نمایش وضعیت دسترسی)
    function loadAllMenus() {
        fetch('/api/menus') // این اندپوینت تمام منوها را برمی‌گرداند (فقط برای ادمین)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                allMenus = data;
                // نیازی به رندر کردن فوری نیست، در loadUserRolesAndMenus استفاده می‌شود.
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری تمام منوها: ' + error.message, 'error');
                console.error('Error loading all menus:', error);
            });
    }

    function loadUserRolesAndMenus() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) {
            document.getElementById('userRoles').innerHTML = '<li>کاربری انتخاب نشده است.</li>';
            document.getElementById('allMenusWithAccessStatus').innerHTML = '<li>کاربری انتخاب نشده است.</li>';
            showMessageManage('', '');
            return;
        }

        // 1. بارگذاری نقش‌های کاربر
        fetch(`/api/users/${userId}/roles`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const ul = document.getElementById('userRoles');
                ul.innerHTML = '';
                if (data.length === 0) {
                    ul.innerHTML = '<li>این کاربر نقشی ندارد.</li>';
                } else {
                    data.forEach(roleName => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${roleName}</span>
                            <button class="remove-role-btn" onclick="removeRoleFromUser(${userId}, '${roleName}')">حذف نقش</button>
                        `;
                        ul.appendChild(li);
                    });
                }
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری نقش‌های کاربر: ' + error.message, 'error');
                console.error('Error loading user roles:', error);
            });

        // 2. بارگذاری منوهای قابل دسترسی این کاربر و نمایش وضعیت دسترسی (نیاز به اندپوینت جدید در MenuService)
        // این بخش از اندپوینت /api/menus/for-user/{userId} استفاده می‌کند.
        // این اندپوینت منوهایی را برمی‌گرداند که کاربر به آن‌ها دسترسی دارد.
        fetch(`/api/menus/for-user/${userId}`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(accessibleMenusData => {
                const ul = document.getElementById('allMenusWithAccessStatus');
                ul.innerHTML = '';

                if (allMenus.length === 0) {
                    ul.innerHTML = '<li>منویی در سیستم ثبت نشده است.</li>';
                    return;
                }

                // ایجاد Set از نام مجوزهای منوهای قابل دسترسی برای جستجوی سریع
                const accessibleMenuTitles = new Set(accessibleMenusData.map(menu => menu.title));

                allMenus.forEach(menu => {
                    const li = document.createElement('li');
                    const hasAccess = accessibleMenuTitles.has(menu.title);
                    const statusClass = hasAccess ? 'has-access' : 'no-access';
                    const statusText = hasAccess ? '✅ دارد' : '❌ ندارد';

                    li.innerHTML = `
                        <span>${menu.title} (${menu.url})</span>
                        <span class="${statusClass} menu-item-status">دسترسی: ${statusText}</span>
                        `;
                    ul.appendChild(li);
                });

            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری منوهای قابل دسترسی کاربر: ' + error.message, 'error');
                console.error('Error loading user accessible menus:', error);
            });
        showMessageManage('', '');
    }

    function assignRoleToUser() {
        const userId = document.getElementById('userSelect').value;
        const roleName = document.getElementById('roleSelect').value;

        if (!userId || !roleName) {
            alert('لطفاً هم کاربر و هم نقش را انتخاب کنید.');
            return;
        }

        fetch(`/api/users/${userId}/roles`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roleName: roleName })
        })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(text || `HTTP error! status: ${res.status}`);
                    });
                }
                return res.text();
            })
            .then(message => {
                showMessageManage(message, 'success');
                loadUserRolesAndMenus(); // بارگذاری مجدد اطلاعات کاربر
            })
            .catch(error => {
                showMessageManage('❌ خطا در اختصاص نقش: ' + error.message, 'error');
                console.error('Error assigning role:', error);
            });
    }

    function removeRoleFromUser(userId, roleName) {
        if (confirm(`آیا مطمئن هستید که می‌خواهید نقش "${roleName}" را از کاربر حذف کنید؟`)) {
            fetch(`/api/users/${userId}/roles/${roleName}`, {
                method: 'DELETE'
            })
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => {
                            throw new Error(text || `HTTP error! status: ${res.status}`);
                        });
                    }
                    return res.text();
                })
                .then(message => {
                    showMessageManage(message, 'success');
                    loadUserRolesAndMenus(); // بارگذاری مجدد اطلاعات کاربر
                })
                .catch(error => {
                    showMessageManage('❌ خطا در حذف نقش: ' + error.message, 'error');
                    console.error('Error removing role:', error);
                });
        }
    }

    window.onload = loadUsers;
</script>
</body>
</html>