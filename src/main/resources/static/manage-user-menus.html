<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مدیریت منوهای کاربران</title>
</head>
<body>

<h2>مدیریت منوهای کاربران</h2>

<!-- انتخاب یوزر -->
<label>کاربر:</label>
<select id="userSelect" onchange="loadUserMenus()">
    <!-- یوزرها با JS پر میشه -->
</select>

<h3>منوهای این کاربر</h3>
<ul id="userMenus"></ul>

<h3>افزودن منو به کاربر</h3>

<!-- انتخاب منو از لیست موجود -->
<label>منو:</label>
<select id="menuSelect">
    <!-- منوها با JS پر میشه -->
</select><br><br>

<button onclick="addMenuToUser()">ثبت</button>

<script>
    let allMenus = [];

    function loadUsers() {
        fetch('/admin/users')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('userSelect');
                select.innerHTML = '';
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.innerText = user.username;
                    select.appendChild(option);
                });
                if (data.length > 0) {
                    loadMenus();
                    loadUserMenus();
                }
            });
    }

    function loadMenus() {
        fetch('/api/menus')
            .then(res => res.json())
            .then(data => {
                allMenus = data;
                const select = document.getElementById('menuSelect');
                select.innerHTML = '';
                data.forEach(menu => {
                    const option = document.createElement('option');
                    option.value = menu.id;
                    option.innerText = menu.title; // فقط نام منو
                    select.appendChild(option);
                });
            });
    }


    function loadUserMenus() {
        const userId = document.getElementById('userSelect').value;
        fetch(`/api/user-menus/${userId}`)
            .then(res => res.json())
            .then(data => {
                const ul = document.getElementById('userMenus');
                ul.innerHTML = '';
                data.forEach(menu => {
                    const li = document.createElement('li');
                    li.innerText = `${menu.title} (${menu.url})`;
                    ul.appendChild(li);
                });
            });
    }

    function addMenuToUser() {
        const userId = document.getElementById('userSelect').value;
        const selectedMenuId = document.getElementById('menuSelect').value;
        const menu = allMenus.find(m => m.id == selectedMenuId);

        if (!menu) return;

        fetch(`/api/user-menus/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: menu.title,
                url: menu.url,
                permission: menu.permission
            })
        }).then(() => loadUserMenus());
    }

    window.onload = loadUsers;
</script>

</body>
</html>
