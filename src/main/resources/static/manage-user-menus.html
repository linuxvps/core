<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مدیریت نقش‌های کاربران و منوهای قابل دسترسی</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h2, h3 { color: #0056b3; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, button { padding: 10px 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ddd; font-size: 1rem; cursor: pointer; }
        button { background-color: #007bff; color: white; border: none; }
        button:hover { background-color: #0056b3; }
        ul { list-style-type: none; padding: 0; }
        li { background-color: #e9e9e9; margin-bottom: 8px; padding: 10px; border-radius: 5px; }
        #userRoles, #userAccessibleMenus { border: 1px solid #ccc; padding: 10px; min-height: 50px; background-color: white; border-radius: 5px; }
        #message-manage { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<h2>مدیریت نقش‌های کاربران و مشاهده منوها</h2>

<label for="userSelect">انتخاب کاربر:</label>
<select id="userSelect" onchange="loadUserRolesAndMenus()">
</select>

<h3>نقش‌های این کاربر</h3>
<ul id="userRoles"></ul>

<h3>منوهای قابل دسترسی این کاربر (بر اساس نقش‌ها)</h3>
<ul id="userAccessibleMenus"></ul>

<h3>اختصاص نقش به کاربر</h3>
<label for="roleSelect">انتخاب نقش:</label>
<select id="roleSelect">
</select><br><br>

<button onclick="assignRoleToUser()">اختصاص نقش</button>

<p id="message-manage"></p>

<br>
<a href="user-list.html">⬅️ بازگشت به لیست کاربران</a>

<script>
    let allRoles = [];

    function showMessageManage(msg, type) {
        const messageElement = document.getElementById('message-manage');
        messageElement.innerText = msg;
        messageElement.className = '';
        if (type) {
            messageElement.classList.add(type);
        }
    }

    function loadUsers() {
        fetch('/api/users')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">-- یک کاربر انتخاب کنید --</option>';
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.innerText = user.username;
                    select.appendChild(option);
                });
                if (data.length > 0) {
                    loadRoles(); // بارگذاری نقش‌ها پس از بارگذاری کاربران
                }
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری کاربران: ' + error.message, 'error');
                console.error('Error loading users:', error);
            });
    }

    function loadRoles() {
        // این فراخوانی منجر به خطای 404 می‌شود:
        fetch('/api/roles')
            .then(res => {
                if (!res.ok) {
                    // در صورت خطای 404 یا 403، پیام دقیق‌تری نمایش داده شود.
                    throw new Error(`HTTP error! status: ${res.status} - ${res.status === 404 ? 'اندپوینت یافت نشد یا دسترسی رد شد.' : 'خطای سرور.'}`);
                }
                return res.json();
            })
            .then(data => {
                allRoles = data;
                const select = document.getElementById('roleSelect');
                select.innerHTML = '';
                data.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.innerText = role.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری نقش‌ها: ' + error.message, 'error');
                console.error('Error loading roles:', error);
            });
    }

    function loadUserRolesAndMenus() {
        const userId = document.getElementById('userSelect').value;
        if (!userId) {
            document.getElementById('userRoles').innerHTML = '<li>کاربری انتخاب نشده است.</li>';
            document.getElementById('userAccessibleMenus').innerHTML = '<li>کاربری انتخاب نشده است.</li>';
            showMessageManage('', '');
            return;
        }

        fetch(`/api/users/${userId}/roles`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const ul = document.getElementById('userRoles');
                ul.innerHTML = '';
                if (data.length === 0) {
                    ul.innerHTML = '<li>این کاربر نقشی ندارد.</li>';
                } else {
                    data.forEach(roleName => {
                        const li = document.createElement('li');
                        li.innerText = roleName;
                        ul.appendChild(li);
                    });
                }
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری نقش‌های کاربر: ' + error.message, 'error');
                console.error('Error loading user roles:', error);
            });

        fetch(`/api/menus/for-user/${userId}`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const ul = document.getElementById('userAccessibleMenus');
                ul.innerHTML = '';
                if (data.length === 0) {
                    ul.innerHTML = '<li>این کاربر به هیچ منویی دسترسی ندارد.</li>';
                } else {
                    data.forEach(menu => {
                        const li = document.createElement('li');
                        li.innerText = `${menu.title} (${menu.url})`;
                        ul.appendChild(li);
                    });
                }
            })
            .catch(error => {
                showMessageManage('❌ خطا در بارگذاری منوهای قابل دسترسی کاربر: ' + error.message, 'error');
                console.error('Error loading user accessible menus:', error);
            });
        showMessageManage('', '');
    }

    function assignRoleToUser() {
        const userId = document.getElementById('userSelect').value;
        const roleName = document.getElementById('roleSelect').value;

        if (!userId || !roleName) {
            alert('لطفاً هم کاربر و هم نقش را انتخاب کنید.');
            return;
        }

        fetch(`/api/users/${userId}/roles`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roleName: roleName })
        })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(text || `HTTP error! status: ${res.status}`);
                    });
                }
                return res.text();
            })
            .then(message => {
                showMessageManage(message, 'success');
                loadUserRolesAndMenus();
            })
            .catch(error => {
                showMessageManage('❌ خطا در اختصاص نقش: ' + error.message, 'error');
                console.error('Error assigning role:', error);
            });
    }

    window.onload = loadUsers;
</script>
</body>
</html>