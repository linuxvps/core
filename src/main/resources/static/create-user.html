<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ایجاد کاربر جدید</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h2 { color: #0056b3; }
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { background-color: #218838; }
        #message-create { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        a { display: inline-block; margin-top: 20px; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; }
        a:hover { background-color: #0056b3; }
    </style>
</head>
<body>
<h2>ایجاد کاربر جدید</h2>

<form id="createUserForm">
    <div>
        <label for="username">نام کاربری:</label>
        <input type="text" id="username" name="username" required>
    </div>
    <div>
        <label for="password">رمز عبور:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <div>
        <label for="roles">نقش‌ها (چند انتخاب با Ctrl/Cmd):</label>
        <select id="roles" name="roles" multiple required>
        </select>
    </div>
    <button type="submit">ایجاد کاربر</button>
</form>

<p id="message-create"></p>

<br>
<a href="user-list.html">⬅️ بازگشت به لیست کاربران</a>

<script>
    function showMessageCreate(msg, type) {
        const messageElement = document.getElementById('message-create');
        messageElement.innerText = msg;
        messageElement.className = '';
        if (type) {
            messageElement.classList.add(type);
        }
    }

    function loadRolesForCreateUser() {
        fetch('/api/roles')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const select = document.getElementById('roles');
                select.innerHTML = '';
                data.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.innerText = role.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                showMessageCreate('❌ خطا در بارگذاری نقش‌ها: ' + error.message, 'error');
                console.error('Error loading roles for create user:', error);
            });
    }

    document.getElementById('createUserForm').addEventListener('submit', function(event) {
        event.preventDefault(); // جلوگیری از ارسال فرم به صورت پیش فرض

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const rolesSelect = document.getElementById('roles');
        const selectedRoles = Array.from(rolesSelect.selectedOptions).map(option => option.value);

        fetch('/api/users', { // مسیر API را به /api/users تغییر دهید
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password,
                roles: selectedRoles
            })
        })
            .then(response => {
                if (response.ok) {
                    showMessageCreate('✅ کاربر با موفقیت ایجاد شد', 'success');
                    document.getElementById('createUserForm').reset(); // ریست کردن فرم
                    loadRolesForCreateUser(); // بارگذاری مجدد نقش‌ها اگر نیاز باشد
                } else {
                    response.text().then(errorMessage => {
                        showMessageCreate('❌ خطا در ایجاد کاربر: ' + errorMessage, 'error');
                    }).catch(err => {
                        showMessageCreate('❌ خطا در ایجاد کاربر (پیام نامشخص)', 'error');
                        console.error('Error parsing error message:', err);
                    });
                }
            })
            .catch(error => {
                showMessageCreate('❌ خطای شبکه در ایجاد کاربر: ' + error.message, 'error');
                console.error('Network error:', error);
            });
    });

    window.onload = loadRolesForCreateUser; // بارگذاری نقش‌ها هنگام لود شدن صفحه
</script>
</body>
</html>